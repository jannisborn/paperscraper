---
name: Source
on: [push, release]

jobs:
  test-source-install:
    runs-on: ubuntu-latest
    env:
      SS_API_KEY: ${{ secrets.SS_API_KEY }}
    strategy:
      max-parallel: 3
      matrix:
        python-version:
          - "3.10"
    steps:
      - name: Checkout
        uses: actions/checkout@v4
      - name: Set up Python
        uses: actions/setup-python@v4
        with:
          python-version: ${{ matrix.python-version }}
      - name: Set up uv
        uses: astral-sh/setup-uv@v3
        with:
          version: "latest"
          enable-cache: true
          cache-dependency-glob: "pyproject.toml"
      - name: Sync dependencies
        run: uv sync --group dev
      - name: Export AWS secrets
        env:
          AWS_ACCESS_KEY_ID: ${{ secrets.AWS_ACCESS_KEY_ID }}
          AWS_SECRET_ACCESS_KEY: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
        run: |
          echo "AWS_ACCESS_KEY_ID=$AWS_ACCESS_KEY_ID" >> api_keys.txt
          echo "AWS_SECRET_ACCESS_KEY=$AWS_SECRET_ACCESS_KEY" >> api_keys.txt
          unset AWS_ACCESS_KEY_ID
          unset AWS_SECRET_ACCESS_KEY
      - name: Test package from source
        run: |
          uv run python -c "import paperscraper"
          uv run coverage run -m pytest -sv paperscraper
          uv run coverage report
          uv run coverage xml -o coverage.xml
      - name: Upload to Codecov
        if: matrix.python-version == '3.10'
        uses: codecov/codecov-action@v2
        with:
          files: coverage.xml
          token: ${{ secrets.CODECOV_TOKEN }}
          fail_ci_if_error: true

  test-potential-wheel-install:
    runs-on: ubuntu-latest
    env:
      SS_API_KEY: ${{ secrets.SS_API_KEY }}
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
      with:
        repository: ${{ github.event.pull_request.head.repo.full_name }}
        ref: ${{ github.event.pull_request.head.ref }}

    - name: Set up Python
      uses: actions/setup-python@v4
      with:
        python-version: "3.10"

    - name: Set up uv
      uses: astral-sh/setup-uv@v3
      with:
        version: "latest"
        enable-cache: true
        cache-dependency-glob: "pyproject.toml"

    - name: Export AWS secrets
      env:
        AWS_ACCESS_KEY_ID: ${{ secrets.AWS_ACCESS_KEY_ID }}
        AWS_SECRET_ACCESS_KEY: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
      run: |
        echo "AWS_ACCESS_KEY_ID=$AWS_ACCESS_KEY_ID" >> api_keys.txt
        echo "AWS_SECRET_ACCESS_KEY=$AWS_SECRET_ACCESS_KEY" >> api_keys.txt
        unset AWS_ACCESS_KEY_ID
        unset AWS_SECRET_ACCESS_KEY

    - name: Install dependencies
      run: |
        uv venv
        uv pip install build pytest

    - name: Build package
      run: |
        uv run python -m build

    - name: Install from built distribution
      run: |
        # Check if a wheel exists, and install it if available, otherwise install the source distribution
        if [ -e dist/*.whl ]; then
          uv pip install dist/*.whl
        else
          uv pip install dist/*
        fi
    - name: Import package
      run: |
        uv run python -c "import paperscraper"
    - name: Run tests
      run: |
        uv run python -m pytest paperscraper
